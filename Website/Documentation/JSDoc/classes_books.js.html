<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: classes/books.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: classes/books.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @classdesc Handles all of the functionality relating to the handling of multiple 'Books'.
 * 
 * @class
 * @hideconstructor
 */
const Books = (function() { // eslint-disable-line no-unused-vars
    var currentUserId; //ID of the current user
    var bookList = []; //Stores the list of retrieved books
    const defaultBookPage = {
        _id: null,
        title: null,
        pageCount: null,
        currentPage: {
            src: "testimage.jpg",
            pageNum: 0
        }
    };

    var currentBookPage = new BookPage(defaultBookPage);

    var bookListObserver = new Observer();
    var updateBookPageObserver = new Observer();

    /**
     * Returns bookListObserver
     * 
     * @memberof Books
     * @return {Observer} Observer for the bookList
     */
    function getBookListObserver() {
        return bookListObserver;
    }
    /**
     * Returns updateBookPageObserver
     * 
     * @memberof Books
     * @return {Observer} Observer for updating the current page and book
     */
    function getUpdateBookPageObserver() {
        return updateBookPageObserver;
    }

    /**
     * Sets the current user id - Value may only be set once
     * 
     * @param {String} newUserId - ID to set currentUserID as
     * @memberof Books
     */
    function setCurrentUserId(newUserId) {
        if (!currentUserId) {
            currentUserId = newUserId;
        } else {
            console.error("Current User Id may only be set once");
        }
    }
    /**
     * Returns currentUserId
     * 
     * @return {String} The current User ID
     * @memberof Books
     */
    function getCurrentUserId() {
        return currentUserId;
    }

    /**
     * Sends a request to the server to retrieve the list of all books
     * NOTE: This retrieves basic information about each book to avoid the amount
     * of bandwidth required to transfer all of the images stored in each 'Book'
     * 
     * @memberof Books
     */
    function retrieveBookList() {
        var self = this;
        $.post("http://localhost:9000/books/getallbooks", {}).done(function(data) {
            if (data.success) {
                self.setBookList(data.result);
            } else {
                alert("An error has occured when retrieving book list. Please try again");
                console.log(data);
            }
        });
    }

    /**
     * Sends a request to the server to retrieve the list of all books
     * NOTE: This retrieves basic information about each book to avoid the amount
     * of bandwidth required to transfer all of the images stored in each 'Book'
     * 
     * @param {Object[]} books - An array of objects containing the basic information about a set of books 
     * @memberof Books
     */
    function setBookList(books) {
        bookList = [];

        for (var book in books) {
            bookList.push(new Book(books[book]));
        }
        bookListObserver.notify(bookList);
    }

    /**
     * Returns the bookList
     * 
     * @returns {Book[]} The current list of books
     * @memberof Books
     */
    function getBookList() {
        return bookList;
    }

    /**
     * Returns the currentBookPage
     * 
     * @returns {BookPage} Current book page
     */
    function getCurrentBookPage() {
        return currentBookPage;
    }

    /**
     * Sets the current book/page, then notifies the updateBookPageObserver
     * 
     * @param {Object} data - Data of the book + page
     */
    function setCurrentBookPage(data) {
        if (data &amp;&amp; Object.keys(data).length) {
            currentBookPage = new BookPage({
                _id: data._id,
                title: data.title,
                pageCount: data.pageCount,
                currentPage: data.currentPage
            });
            updateBookPageObserver.notify(currentBookPage);
        } else {
            resetCurrentBookPage();
        }
    }

    /**
     * Retrieves a new page from the current book
     * 
     * @param {Integer} pageNum - Number of the page (starts from 0)
     * @memberof Books
     */
    function retrieveNewPageFromBook(bookId, pageNum, callback) {
        if (bookId != null &amp;&amp; pageNum != null) {
            for (var book in bookList) {
                if (bookList[book]._id == bookId) {
                    bookList[book].getPageData(pageNum, function(data) {
                        callback(data);
                    });
                }
            }
        }
    }

    /**
     * Resets the currentBookPage to the defaultBookPagePage
     * 
     * @memberof Books
     */
    function resetCurrentBookPage() {
        setCurrentBookPage(defaultBookPage);
    }

    function setCurrentBookPageFromServer(pageNum) {
        retrieveNewPageFromBook(currentBookPage._id, pageNum, function(data) {
            var bookDetails = {
                _id: currentBookPage._id,
                title: currentBookPage.title,
                pageCount: data.pageCount,
                currentPage: {
                    contentType: data.pages[0].contentType,
                    imageData: data.pages[0].data.data,
                    pageNum: data.pages[0].pageNum
                }
            };
            setCurrentBookPage(bookDetails);
        });
    }

    /**
     * Given a session, find the details of the book/page and retrieve the page from the book.
     * 
     * @param {Session} Session to retrieve book details from
     * @memberof Books
     */
    function getSessionBookPage(session) {
        if (session) {
            retrieveNewPageFromBook(session.currentBook._id, session.currentPageNum, function(data) {
                var bookDetails = {
                    _id: session.currentBook._id,
                    title: session.currentBook.title,
                    pageCount: data.pageCount,
                    currentPage: {
                        contentType: data.pages[0].contentType,
                        imageData: data.pages[0].data.data,
                        pageNum: data.pages[0].pageNum
                    }
                };
                setCurrentBookPage(bookDetails);
            });
        } else {
            resetCurrentBookPage();
        }
    }

    return {
        getBookListObserver,
        getUpdateBookPageObserver,
        setCurrentUserId,
        getCurrentUserId,
        retrieveBookList,
        setBookList,
        getBookList,
        getCurrentBookPage,
        setCurrentBookPage,
        retrieveNewPageFromBook,
        resetCurrentBookPage,
        getSessionBookPage,
        setCurrentBookPageFromServer
    };
})();

/**
 * Handles all of the functionality related to an individual book
 * @constructor
 */
function Book(bookDetails) {
    /**
     * The title of the book
     * 
     * @member {String}
     */
    this.title = bookDetails.title;
    /**
     * The id of the book
     * 
     * @member {String}
     */
    this._id = bookDetails._id;

    /**
     * The number of pages in the book
     */
    this.pageCount = bookDetails.pageCount;

    /**
     * Retrieves the data of a given page of the book
     * 
     * @param {Integer} pageNum - The number of the page you want to retrieve
     * @param {Function} callback - The function to execute after the page is successfully retrieved
     */
    this.getPageData = function(pageNum, callback) {
        if (pageNum >= 0 || pageNum &lt; this.pageCount) {
            $.post("http://localhost:9000/books/getpagefrombook", {
                bookId: this._id,
                pageNum: pageNum
            }).done(function(data) {
                if (data.success) {
                    callback(data.result);
                } else {
                    alert("An error has occured retrieving the page data. Please try again");
                    console.log(data);
                }
            });
        } else {
            console.error("This books does not have page number " + pageNum);
        }
    };
}

function BookPage(bookPageDetails) {
    this._id = bookPageDetails._id;

    this.title = bookPageDetails.title;

    this.pageCount = bookPageDetails.pageCount;

    this.currentPage = new Page(bookPageDetails.currentPage);
}
/**
 * Handles all of the functionality related to an individual page
 * @constructor
 */
function Page(pageDetails) {
    /**
     * The number of the page - Starts from 0
     * @member {Integer}
     */
    this.pageNum = pageDetails.pageNum;
    /**
     * The source of the page image
     * @member {String}
     */
    this.src = null;

    //Page src can come in two formats
    //Name of local files or the image data
    if (pageDetails.src) {
        this.src = pageDetails.src;
    } else if (pageDetails.imageData) {
        this.src = "data:" + pageDetails.contentType + ";base64," + util_encode(pageDetails.imageData);
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Book.html">Book</a></li><li><a href="Books.html">Books</a></li><li><a href="Chat.html">Chat</a></li><li><a href="ChatMessage.html">ChatMessage</a></li><li><a href="CollabBookReader.html">CollabBookReader</a></li><li><a href="Note.html">Note</a></li><li><a href="Notes.html">Notes</a></li><li><a href="Observer.html">Observer</a></li><li><a href="Page.html">Page</a></li><li><a href="Session.html">Session</a></li><li><a href="Sessions.html">Sessions</a></li><li><a href="User.html">User</a></li><li><a href="Users.html">Users</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AngularMainApp">AngularMainApp</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Dec 22 2018 21:57:08 GMT+0000 (GMT Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
